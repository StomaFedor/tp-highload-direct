# Яндекс.Директ

Курсовая работа в рамках 3-го семестра программы по Веб-разработке ОЦ VK x МГТУ им. Н.Э. Баумана (ex. "Технопарк") по дисциплине "Проектирование высоконагруженных сервисов"

#### Автор - [Стома Фёдор](https://park.vk.company/profile/f.stoma/ "Страница на портале VK x МГТУ")
#### Задание - [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)

#### Содержание:
1. [Тема, функционал и аудитория](#1)
2. [Расчёт нагрузки](#2)
3. [Глобальная балансировка нагрузки](#3)
4. [Локальная балансировка нагрузки](#4)
5. [Логическая схема базы данных](#5)
6. [Физическая схема базы данных](#6)
7. [Алгоритмы](#7)
8. [Технологии](#8)
9. [Обеспечение надёжности](#9)
10. [Схема проекта](#10)
11. [Расчёт ресурсов](#11)

## Тема, функционал и целевая аудитория <a name="1"></a>

### 1.1 Тема
[Яндекс.Директ](https://direct.yandex.ru/) - система контекстной рекламы на страницах «Яндекса» и сайтах партнёров Рекламной системы Яндекса.

### 1.2 Функционал сервиса (MVP)
- Показ рекламных объявлений
Показ рекламных объявлений может совершаться по различным таргетингам, например:
 1) Ключевые слова в поисковом запросе
 2) Географический
 3) По полу и возрасту
 4) Временной

- Создание рекламных объявлений

- Модель продажи рекламы
  1) CPC (цена за клик)
  2) Количество показов объявлений
 
- Управление рекламными компаниями (настройка, просмотр статистики)

### 1.3 Целевая аудитория
Пользователи:
- Среднемесячная аудитория рекламной сети Яндекса - 93.1 млн. человек [^1]
- Среднесуточная аудитория рекламной сети Яндекса - 65 млн. человек [^1]

Рекламодатели:
- Среднесуточное количество показа рекламных объявлений - 4.96 млрд. объявлений [^2]
- Количество активных рекламодателей Яндекс Директа - 1,5 млн. человек 

## Расчёт нагрузки <a name="2"></a>
### 2.1 Расчет
#### Рассчет хранилища:  
Объем рекламы в Яндекс.Директ зависит от типа рекламы:
- Текстово-графическая реклама - 1 Кб [^3]
- Медиа реклама - от 150 Кб до 10 Мб [^3]
- Видео реклама - от 1 Мб до 100 Мб [^3]
Также стоит учитывать количество ключевых слов в контекстной рекламе для объявления. Для оптимальной выдачи рекламы количество ключевых слов равняется 1000. Возьмем среднюю длину каждого ключевого слова в размере 10 символов. При условии, что один символ занимает 1 байт, общий объем памяти для ключевых слов будет около 10 КБ.

Предположим, каждое объявление, которое находится в активном использовании, показывают около 10 раз в сутки. Т.е. количество активных объявлений равно:  
`4.96 млрд. / 10 = 496 млн.`  
Допустим, у рекламодателя всего 30% объвлений являются активными. В таком случае общее количество хранящихся объявлений равно:  
`496 млн. / 30 * 100 = 1.653 млрд.`  
  
По статистике [^1] в объем пользователей Я.Директ на различных площадках равен:
- Я.Поиск - 5.16 млн.
- РСЯ - 55.4 млн.
- Пересечение аудиторий - 34.75 млн.
Будем считать соотношение количества рекламы на различных площадках равным количеству пользователей. Следовательно:  
`(5.16 млн. + 34.75 млн. / 2) / 95 млн.  = 24%` - процент рекламы Я.Поиск  
`100 - 24  = 76%` - процент рекламы РСЯ  
`1.653 млрд. * 24% = 396.7 млн.` - количество рекламы, показываемой в Я.Поиск  
`1.653 млрд. * 76% = 1.25 млрд.` - количество рекламы, показываемой в РСЯ  

Я.Поиск:  
В поиске Яндекса доминируют текстово-графические объявления, которые составляют более 90% от всех рекламных показов.  
`(1 + 10) Кб * 396.7 млн. * 0.9 = 3.65 Тб` - объем памяти, занимаемый текстово-графическими объявлениями в Я.Поиск  
Примем средний размер медиа и видео рекламы за 5Мб (с учетом ключевых слов):  
`5 Мб * 396.7 млн. * 0.1 = 189.16 Тб` - объем памяти, занимаемый медиа и видео рекламой в Я.Поиск  
  
РСЯ:  
Распределение рекламы в РСЯ:
- Текстово-графические объявления - 60%
- Медиа реклама - 30%
- Видео реклама - 10%  
`(1 + 10) Кб * 1.25 млрд. * 0.6 = 7.68 Тб` - объем памяти, занимаемый текстово-графическими объявлениями в РСЯ  
Примем средний размер медиа рекламы за 4Мб (с учетом ключевых слов):  
`4 Мб * 1.25 млрд. * 0.3 = 1430.51 Тб` - объем памяти, занимаемый медиа рекламой в РСЯ  
Примем средний размер видео рекламы за 7Мб (с учетом ключевых слов):  
`7 Мб * 1.25 млрд. * 0.1 = 834.46 Тб` - объем памяти, занимаемый видео рекламой в РСЯ  

#### Рассчет RPS и сетевого трафика:  
Общий процент показа:
- Текстово-графических объявлений:
  `(0.3967 млрд. * 0.9 + 1.25 млрд. * 0.6) / 1.653 млрд. = 67%`  
- Медиа рекламы:
  `(0.3967 млрд. * 0.07 + 1.25 млрд. * 0.3) / 1.653 млрд. = 24%`  
- Видео рекламы:
  `100% - 67% - 24% = 9%`

RPS:
Предположим, что 8% пользователей переходят по рекламе. Тогда средний RPS кликов: 
- Текстово-графических объявлений:  
  `4.96 * 10^9 * 67% / 24 / 3600 = 38462` - средний RPS показов  
  `38462 * 8%= 3077` - средний RPS кликов  
- Медиа рекламы:  
  `4.96 * 10^9 * 24% / 24 / 3600 = 13778` - средний RPS показов  
  `13778 * 8%= 1102` - средний RPS кликов  
- Видео рекламы:  
  `4.96 * 10^9 * 9% / 24 / 3600 = 5167` - средний RPS показов  
  `5167 * 8%= 413` - средний RPS кликов  
  
Сетевой трафик:
- Текстово-графические объявления:
  `(1 + 10) Кб * 38462 = 3.23 Гбит/c`
- Медиа реклама:
  `4 Мб * 13778 = 430 Гбит/c`
- Видео реклама:
  `7 Мб * 5167 = 282 Гбит/c`

Допустим, каждый рекламодатель в среднем запрашивает статистику около 4 раз в сутки. Получим:  
`1.5 * 10^6 * 4 / 24 / 3600 = 69` - средний RPS по запросу статистики рекламной кампании

По данным из итогов модерации рекламы в Яндекс [^2] Пульт управления рекламой используют 112 млн. раза в месяц. Следовательно:  
`112 * 10^6 / 31 / 24 / 3600 = 41` - средний RPS по созданию рекламы

### 2.2 Продуктовые метрики
|Метрика|Значение|Обозначение|
| ------------- | -------------|--|
|MAU (чел.)|93.1 млн.|MAU|
|DAU (чел.)|65 млн.|DAU|
|Размер текстово-графической рекламы|11Кб|SIZE_GRATH|
|Размер медиа рекламы|4Мб|SIZE_MEDIA|
|Размер видео рекламы|7Мб|SIZE_VIDEO|
|Количество рекламодателей|1.5 млн.|ADVERTISER_ALL|
|Новых объявлений в месяц|112 млн.|ADVERTISEMENT_NEW|
|Количество объявлений|1.653 млрд.|ADVERTISEMENT_ALL|
|Объем памяти, занимаемый текстово-графическими объявлениями в Я.Поиск|3.65 Тб|SIZE_TEXT_SEARCH|
|Объем памяти, занимаемый медиа и видео рекламой в Я.Поиск|189.16 Тб|SIZE_MEDIA&VIDEO_SEARCH|
|Объем памяти, занимаемый текстово-графическими объявлениями в РСЯ|7.68 Тб|SIZE_TEXT_YAN|
|Объем памяти, занимаемый медиа рекламой в РСЯ|1430.51 Тб|SIZE_MEDIA_YAN|
|Объем памяти, занимаемый видео рекламой в РСЯ|834.46 Тб|SIZE_VIDEO_YAN|



### 2.3 Технические метрики
| Запрос                                 | RPS (средний)   | RPS (пиковый) |
| ------------------------------------------------ | --------------- | ------------  |
| Создание объявлений                              | 41              | 82            |
| Просмотр статистики                              | 69              | 138           |
| Подбор текстово-графических объявлений           | 38462           | 76924         |
| Подбор медиа рекламы                             | 13778           | 27556         |
| Подбор видео рекламы                             | 5167            | 10334         |
| Обработка кликов текстово-графических объявлений | 3077            | 6154          |
| Обработка кликов медиа рекламы                   | 1102            | 2204          |
| Обработка кликов видео рекламы                   | 413             | 826           |


| Запрос                                 | Потребляемый трафик (средний) |
| -------------------------------------- | ----------------------------- |
| Подбор текстово-графических объявлений | 3.23 Гбит/с                   |
| Подбор медиа рекламы                   | 430 Гбит/с                    |
| Подбор видео рекламы                   | 282 Гбит/с                    |
 
## Глобальная балансировка нагрузки <a name="3"></a>
Так как основная аудитория Я.Директ находится в России, распологать ЦОД-ы будем в России.  
Если мы посмотрим на карту плотности населения России:
![image](https://github.com/StomaFedor/tp-highload-direct/assets/107150041/51ca9511-e3a1-4fb1-a115-d80b8c1cfe5a)
То мы можем увидеть, что основная нагрузка будет приходиться на Центральный регион. Поэтому основную часть ЦОД-ов будем размещать там.  
  
Также, выбирая города, стоит обратить внимание магистрали сети:
![image](https://github.com/StomaFedor/tp-highload-direct/assets/107150041/fe2b93f3-73eb-4ae5-a286-17aa970dfc8a)
В связи с этим для размещения датацентров были выбраны следующие города:
- Москва
- Санкт-Петербург
- Екатеринбург
- Новосибирск
  
Для балансировки клиентов будем использовать GeoDNS. ЦОД-ы будут отвечать за следующие районы:
- Москва -> Москва, Московская область
- Санкт-Петербург -> Санкт-Петербург, Ленинградская область
- Екатеринбург -> Средняя часть России
- Новосибирск -> Сибирь
  
Далее будем использовать BGP Anycast для выбора нужного ЦОД-а  

## Локальная балансировка нагрузки <a name="4"></a>
Балансировка будет осуществляться посредством роутинга и L7 балансировщиков.

В качестве L7 балансировщика будем использовать Nginx. Использовать его будем для следующих процессов:
- Отдача статики
- Кеширование запросов
- Сжатие контента (gzip)
- Терминация SSL
- Обеспечение перезапуска сервиса без остановки обслуживания
- Отслеживание обработки медленных клиентов (с помощью использования асинхронной обработки)
- Балансировка запросов между бэкендами с помощью Least Connections

Для удобства регулировки, балансировки и администрирования наш сервис будет находиться внутри kubernetes. Также он позволит нам конфигурировать сервисы при помощи Service discovery.

Для шифрования будем использовать Let`s Encrypt. Так же будем использовать Session Cache для улучшения производительности и ускорения подключения.
## Логическая схема базы данных <a name="5"></a>


## Физическая схема базы данных <a name="6"></a>


## Алгоримты <a name="7"></a>


## Технологии <a name="8"></a>


## Обеспечение надёжности <a name="9"></a>


## Схема проекта <a name="10"></a>


## Расчёт ресурсов <a name="11"></a>


### Список источников:
[^1]: [Статистика аудитории Яндекс.Директ в 2024 году](https://yandex.ru/support/direct/general/yan.html)
[^2]: [Итоги модерации рекламы в Яндекс](https://ya.ru/project/admoderation/2023)
[^3]: [Технические ограничения для объявлений Яндекс.Директ](https://yandex.ru/support/direct/moderation/technical-restrictions.html)
[^4]: [Разбор аналитики рекламных кампаний в Яндекс.Директе](https://romi.center/ru/learning/article/analysis-of-analytics-for-advertising-campaigns-in-yandex-direct/)
